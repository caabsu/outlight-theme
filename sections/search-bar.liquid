{% comment %}
  Standalone search bar section with predictive search
  Same design as mobile menu search bar
{% endcomment %}

<div class="search-bar-section" style="
  --search-bar-padding-top-mobile: {{ section.settings.padding_top_mobile }}px;
  --search-bar-padding-bottom-mobile: {{ section.settings.padding_bottom_mobile }}px;
  --search-bar-padding-x-mobile: {{ section.settings.padding_x_mobile }}px;
  --search-bar-padding-top-desktop: {{ section.settings.padding_top_desktop }}px;
  --search-bar-padding-bottom-desktop: {{ section.settings.padding_bottom_desktop }}px;
">
  <div class="search-bar-section__inner" data-search-bar-section>
    <form action="{{ routes.search_url }}" method="get" class="search-bar-section__form" data-search-bar-form>
      <input type="hidden" name="type" value="product,collection">
      <svg class="search-bar-section__icon" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.5">
        <circle cx="9" cy="9" r="6"/>
        <path d="M13.5 13.5L17 17"/>
      </svg>
      <input
        type="search"
        name="q"
        placeholder="{{ section.settings.placeholder | default: 'What can we help you find?' }}"
        class="search-bar-section__input"
        autocomplete="off"
        data-search-bar-input
      >
    </form>
    <div class="search-bar-section__results" data-search-bar-results></div>
  </div>
</div>

{% stylesheet %}
  .search-bar-section {
    padding-top: var(--search-bar-padding-top-mobile, 24px);
    padding-bottom: var(--search-bar-padding-bottom-mobile, 24px);
    padding-left: var(--search-bar-padding-x-mobile, 16px);
    padding-right: var(--search-bar-padding-x-mobile, 16px);
  }

  .search-bar-section__inner {
    max-width: 100%;
    margin: 0 auto;
    position: relative;
  }

  .search-bar-section__form {
    display: flex;
    align-items: center;
    border-bottom: 1px solid #1C1917;
  }

  .search-bar-section__icon {
    flex-shrink: 0;
    color: #A8A29E;
    margin-right: 10px;
  }

  .search-bar-section__input {
    flex: 1;
    width: 100%;
    padding: 6px 0;
    border: none;
    background: transparent;
    font-family: var(--font-body-family), sans-serif;
    font-size: 16px;
    color: #1C1917;
    outline: none;
  }

  .search-bar-section__input::placeholder {
    color: #A8A29E;
  }

  .search-bar-section__input::-webkit-search-cancel-button {
    -webkit-appearance: none;
    appearance: none;
  }

  .search-bar-section__results {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: #ffffff;
    border-radius: 0 0 8px 8px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
    max-height: 60vh;
    overflow-y: auto;
    opacity: 0;
    visibility: hidden;
    transform: translateY(-8px);
    transition: opacity 0.2s ease, visibility 0.2s ease, transform 0.2s ease;
    z-index: 100;
  }

  .search-bar-section__results.is-visible {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }

  .search-bar-section__group {
    padding: 12px 0;
    border-bottom: 1px solid #E5E5E5;
  }

  .search-bar-section__group:last-child {
    border-bottom: none;
  }

  .search-bar-section__group-title {
    font-family: var(--font-body-family), sans-serif;
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: #A8A29E;
    padding: 0 16px 8px;
    margin: 0;
  }

  .search-bar-section__item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 16px;
    text-decoration: none;
    color: #1C1917;
    transition: background-color 0.15s ease;
  }

  .search-bar-section__item:hover {
    background-color: #F5F5F4;
  }

  .search-bar-section__item-image {
    width: 44px;
    height: 44px;
    flex-shrink: 0;
    overflow: hidden;
    background-color: #F5F5F4;
    border-radius: 4px;
  }

  .search-bar-section__item-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .search-bar-section__item-info {
    display: flex;
    flex-direction: column;
    gap: 2px;
    min-width: 0;
  }

  .search-bar-section__item-title {
    font-family: var(--font-heading-family), serif;
    font-size: 14px;
    font-weight: 400;
    color: #1C1917;
    line-height: 1.3;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .search-bar-section__item-meta {
    font-family: var(--font-body-family), sans-serif;
    font-size: 12px;
    color: #78716C;
  }

  .search-bar-section__no-results {
    padding: 24px 16px;
    text-align: center;
    color: #78716C;
    font-size: 14px;
  }

  .search-bar-section__loading {
    padding: 24px 16px;
    text-align: center;
    color: #A8A29E;
    font-size: 13px;
  }

  /* Desktop: Match bento grid width */
  @media (min-width: 768px) {
    .search-bar-section {
      padding: var(--search-bar-padding-top-desktop, 40px) 40px var(--search-bar-padding-bottom-desktop, 24px);
    }
  }

  @media (min-width: 1200px) {
    .search-bar-section {
      padding: var(--search-bar-padding-top-desktop, 40px) 60px var(--search-bar-padding-bottom-desktop, 24px);
    }
  }
{% endstylesheet %}

{% javascript %}
  (function() {
    const section = document.querySelector('[data-search-bar-section]');
    if (!section) return;

    const input = section.querySelector('[data-search-bar-input]');
    const results = section.querySelector('[data-search-bar-results]');
    const form = section.querySelector('[data-search-bar-form]');

    if (!input || !results) return;

    let cache = {};
    let debounceTimer = null;

    const search = async (query, callback) => {
      if (!query || query.length < 2) {
        callback({ products: [], collections: [] });
        return;
      }

      const cacheKey = query.toLowerCase().trim();
      if (cache[cacheKey]) {
        callback(cache[cacheKey]);
        return;
      }

      try {
        const response = await fetch(
          `/search/suggest.json?q=${encodeURIComponent(query)}&resources[type]=product,collection&resources[limit]=5`
        );
        const data = await response.json();

        const searchResults = {
          products: data.resources?.results?.products || [],
          collections: data.resources?.results?.collections || []
        };

        cache[cacheKey] = searchResults;
        callback(searchResults);
      } catch (error) {
        console.error('Search error:', error);
        callback({ products: [], collections: [] });
      }
    };

    const renderResults = (data) => {
      const { products, collections } = data;

      if (products.length === 0 && collections.length === 0) {
        results.innerHTML = '<div class="search-bar-section__no-results">No results found</div>';
        results.classList.add('is-visible');
        return;
      }

      let html = '';

      // Collections
      if (collections.length > 0) {
        html += '<div class="search-bar-section__group">';
        html += '<h4 class="search-bar-section__group-title">Collections</h4>';
        collections.forEach(collection => {
          html += `
            <a href="${collection.url}" class="search-bar-section__item">
              <div class="search-bar-section__item-image">
                ${collection.featured_image?.url
                  ? `<img src="${collection.featured_image.url}&width=88" alt="${collection.title}" loading="lazy">`
                  : ''}
              </div>
              <div class="search-bar-section__item-info">
                <span class="search-bar-section__item-title">${collection.title}</span>
              </div>
            </a>
          `;
        });
        html += '</div>';
      }

      // Products
      if (products.length > 0) {
        html += '<div class="search-bar-section__group">';
        html += '<h4 class="search-bar-section__group-title">Products</h4>';
        products.forEach(product => {
          let price = '';
          if (product.price) {
            const priceValue = parseFloat(product.price);
            price = new Intl.NumberFormat('en-US', {
              style: 'currency',
              currency: Shopify?.currency?.active || 'USD',
              minimumFractionDigits: priceValue % 1 === 0 ? 0 : 2,
              maximumFractionDigits: 2
            }).format(priceValue);
          }
          html += `
            <a href="${product.url}" class="search-bar-section__item">
              <div class="search-bar-section__item-image">
                ${product.featured_image?.url
                  ? `<img src="${product.featured_image.url}&width=88" alt="${product.title}" loading="lazy">`
                  : ''}
              </div>
              <div class="search-bar-section__item-info">
                <span class="search-bar-section__item-title">${product.title}</span>
                <span class="search-bar-section__item-meta">${price}</span>
              </div>
            </a>
          `;
        });
        html += '</div>';
      }

      results.innerHTML = html;
      results.classList.add('is-visible');
    };

    const hideResults = () => {
      results.classList.remove('is-visible');
    };

    input.addEventListener('input', (e) => {
      const query = e.target.value.trim();

      if (query.length < 2) {
        hideResults();
        return;
      }

      results.innerHTML = '<div class="search-bar-section__loading">Searching...</div>';
      results.classList.add('is-visible');

      if (debounceTimer) clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => {
        search(query, renderResults);
      }, 200);
    });

    input.addEventListener('focus', () => {
      const query = input.value.trim();
      if (query.length >= 2) {
        results.classList.add('is-visible');
      }
    });

    // Hide results when clicking outside
    document.addEventListener('click', (e) => {
      if (!section.contains(e.target)) {
        hideResults();
      }
    });

    // ESC key hides results
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        hideResults();
        input.blur();
      }
    });
  })();
{% endjavascript %}

{% schema %}
{
  "name": "Search bar",
  "settings": [
    {
      "type": "text",
      "id": "placeholder",
      "label": "Placeholder text",
      "default": "What can we help you find?"
    },
    {
      "type": "header",
      "content": "Padding (Mobile)"
    },
    {
      "type": "range",
      "id": "padding_top_mobile",
      "label": "Top padding",
      "min": 0,
      "max": 80,
      "step": 4,
      "unit": "px",
      "default": 24
    },
    {
      "type": "range",
      "id": "padding_bottom_mobile",
      "label": "Bottom padding",
      "min": 0,
      "max": 80,
      "step": 4,
      "unit": "px",
      "default": 24
    },
    {
      "type": "range",
      "id": "padding_x_mobile",
      "label": "Side padding",
      "min": 0,
      "max": 40,
      "step": 4,
      "unit": "px",
      "default": 16
    },
    {
      "type": "header",
      "content": "Padding (Desktop)"
    },
    {
      "type": "range",
      "id": "padding_top_desktop",
      "label": "Top padding",
      "min": 0,
      "max": 120,
      "step": 4,
      "unit": "px",
      "default": 40
    },
    {
      "type": "range",
      "id": "padding_bottom_desktop",
      "label": "Bottom padding",
      "min": 0,
      "max": 80,
      "step": 4,
      "unit": "px",
      "default": 24
    }
  ],
  "presets": [
    {
      "name": "Search bar"
    }
  ]
}
{% endschema %}

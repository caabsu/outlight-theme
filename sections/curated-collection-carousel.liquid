{% comment %}
  Curated Collection Carousel
  Displays products from a collection that the current product belongs to.
  Merchant selects which collections to check - section finds the match.
{% endcomment %}

{%- liquid
  assign matched_collection = nil
  assign curated_collections = section.blocks | where: "type", "collection"

  for block in curated_collections
    assign check_collection = collections[block.settings.collection]
    if check_collection != blank
      for col_product in check_collection.products
        if col_product.id == product.id
          assign matched_collection = check_collection
          break
        endif
      endfor
    endif
    if matched_collection != blank
      break
    endif
  endfor
-%}

{%- if matched_collection != blank -%}
<div
  class="curated-carousel full-width"
  style="
    --cc-bg: {{ section.settings.section_bg }};
    --cc-padding-top: {{ section.settings.padding_top }}px;
    --cc-padding-bottom: {{ section.settings.padding_bottom }}px;
    --cc-title-color: {{ section.settings.title_color }};
    --cc-title-size: {{ section.settings.title_size }}px;
    --cc-title-size-mobile: {{ section.settings.title_size_mobile }}px;
    --cc-title-weight: {{ section.settings.title_weight }};
    --cc-card-bg: {{ section.settings.card_bg }};
    --cc-card-radius: {{ section.settings.card_radius }}px;
    --cc-name-color: {{ section.settings.product_name_color }};
    --cc-name-size: {{ section.settings.product_name_size }}px;
    --cc-name-size-mobile: {{ section.settings.product_name_size_mobile }}px;
    --cc-price-color: {{ section.settings.price_color }};
    --cc-price-size: {{ section.settings.price_size }}px;
    --cc-nav-color: {{ section.settings.nav_color }};
    --cc-nav-bg: {{ section.settings.nav_bg }};
  "
>
  <div class="curated-carousel__container">
    {%- capture section_title -%}
      {%- if section.settings.title_prefix != blank -%}
        {{ section.settings.title_prefix }} {{ matched_collection.title }}
      {%- else -%}
        {{ matched_collection.title }}
      {%- endif -%}
    {%- endcapture -%}

    <div class="curated-carousel__header">
      <h2 class="curated-carousel__title">{{ section_title }}</h2>
      {%- if section.settings.show_view_all -%}
        <a href="{{ matched_collection.url }}" class="curated-carousel__view-all">
          {{ section.settings.view_all_text }}
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M6 12L10 8L6 4"/>
          </svg>
        </a>
      {%- endif -%}
    </div>

    <div class="curated-carousel__wrapper">
      <button class="curated-carousel__nav curated-carousel__nav--prev" aria-label="Previous">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <path d="M15 18L9 12L15 6"/>
        </svg>
      </button>

      <div class="curated-carousel__track">
        {%- for col_product in matched_collection.products limit: section.settings.products_limit -%}
          {%- unless col_product.id == product.id -%}
            <a href="{{ col_product.url }}" class="curated-carousel__card">
              <div class="curated-carousel__image">
                {%- if col_product.featured_image != blank -%}
                  {{ col_product.featured_image | image_url: width: 600 | image_tag: loading: 'lazy' }}
                {%- else -%}
                  {{ 'product-1' | placeholder_svg_tag: 'placeholder-svg' }}
                {%- endif -%}
              </div>
              <div class="curated-carousel__info">
                <h3 class="curated-carousel__name">{{ col_product.title }}</h3>
                <p class="curated-carousel__price">{{ col_product.price | money }}</p>
              </div>
            </a>
          {%- endunless -%}
        {%- endfor -%}
      </div>

      <button class="curated-carousel__nav curated-carousel__nav--next" aria-label="Next">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <path d="M9 18L15 12L9 6"/>
        </svg>
      </button>
    </div>
  </div>
</div>
{%- endif -%}

{% stylesheet %}
  .curated-carousel {
    background: var(--cc-bg);
    padding: var(--cc-padding-top) 0 var(--cc-padding-bottom);
  }

  .curated-carousel__container {
    max-width: var(--page-width);
    margin: 0 auto;
    padding: 0 1.25rem;
  }

  .curated-carousel__header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    gap: 1rem;
  }

  .curated-carousel__title {
    font-family: var(--font-heading-family), serif;
    font-size: var(--cc-title-size-mobile);
    font-weight: var(--cc-title-weight);
    color: var(--cc-title-color);
    margin: 0;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .curated-carousel__view-all {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    font-size: 0.8125rem;
    font-weight: 500;
    color: var(--cc-title-color);
    text-decoration: none;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    white-space: nowrap;
    transition: opacity 0.2s ease;
  }

  .curated-carousel__view-all:hover {
    opacity: 0.7;
  }

  .curated-carousel__wrapper {
    position: relative;
  }

  .curated-carousel__nav {
    display: none;
    position: absolute;
    top: 50%;
    transform: translateY(-80%);
    width: 44px;
    height: 44px;
    background: var(--cc-nav-bg);
    color: var(--cc-nav-color);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    z-index: 10;
    align-items: center;
    justify-content: center;
    transition: opacity 0.2s ease, transform 0.2s ease;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }

  .curated-carousel__nav:hover {
    transform: translateY(-80%) scale(1.05);
  }

  .curated-carousel__nav--prev {
    left: -22px;
  }

  .curated-carousel__nav--next {
    right: -22px;
  }

  .curated-carousel__track {
    display: flex;
    gap: 1rem;
    overflow-x: auto;
    scroll-snap-type: x mandatory;
    scrollbar-width: none;
    -webkit-overflow-scrolling: touch;
    padding-bottom: 0.5rem;
  }

  .curated-carousel__track::-webkit-scrollbar {
    display: none;
  }

  .curated-carousel__card {
    flex: 0 0 160px;
    scroll-snap-align: start;
    text-decoration: none;
    display: block;
    background: var(--cc-card-bg);
    border-radius: var(--cc-card-radius);
    overflow: hidden;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }

  .curated-carousel__card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
  }

  .curated-carousel__image {
    aspect-ratio: 1 / 1;
    overflow: hidden;
    background: #f5f5f5;
  }

  .curated-carousel__image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s ease;
  }

  .curated-carousel__card:hover .curated-carousel__image img {
    transform: scale(1.05);
  }

  .curated-carousel__info {
    padding: 0.875rem 1rem;
  }

  .curated-carousel__name {
    font-family: var(--font-heading-family), serif;
    font-size: var(--cc-name-size-mobile);
    font-weight: 500;
    color: var(--cc-name-color);
    margin: 0 0 0.25rem;
    line-height: 1.3;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .curated-carousel__price {
    font-size: var(--cc-price-size);
    font-weight: 500;
    color: var(--cc-price-color);
    margin: 0;
  }

  /* Desktop styles */
  @media (min-width: 768px) {
    .curated-carousel__container {
      padding: 0 3rem;
    }

    .curated-carousel__header {
      margin-bottom: 2rem;
    }

    .curated-carousel__title {
      font-size: var(--cc-title-size);
    }

    .curated-carousel__nav {
      display: flex;
    }

    .curated-carousel__track {
      gap: 1.5rem;
    }

    .curated-carousel__card {
      flex: 0 0 calc(25% - 1.125rem);
      min-width: 200px;
    }

    .curated-carousel__info {
      padding: 1rem 1.25rem;
    }

    .curated-carousel__name {
      font-size: var(--cc-name-size);
    }
  }

  @media (min-width: 1200px) {
    .curated-carousel__card {
      flex: 0 0 calc(20% - 1.2rem);
    }
  }
{% endstylesheet %}

{% javascript %}
  (function() {
    const section = document.querySelector('.curated-carousel');
    if (!section) return;

    const track = section.querySelector('.curated-carousel__track');
    const prevBtn = section.querySelector('.curated-carousel__nav--prev');
    const nextBtn = section.querySelector('.curated-carousel__nav--next');

    if (!track || !prevBtn || !nextBtn) return;

    const getScrollAmount = () => {
      const card = track.querySelector('.curated-carousel__card');
      if (card) {
        const style = window.getComputedStyle(track);
        const gap = parseInt(style.gap) || 24;
        return card.offsetWidth + gap;
      }
      return 220;
    };

    prevBtn.addEventListener('click', () => {
      track.scrollBy({ left: -getScrollAmount(), behavior: 'smooth' });
    });

    nextBtn.addEventListener('click', () => {
      track.scrollBy({ left: getScrollAmount(), behavior: 'smooth' });
    });

    const updateNavState = () => {
      const isAtStart = track.scrollLeft <= 0;
      const isAtEnd = track.scrollLeft >= track.scrollWidth - track.clientWidth - 1;

      prevBtn.style.opacity = isAtStart ? '0.3' : '1';
      prevBtn.style.pointerEvents = isAtStart ? 'none' : 'auto';
      nextBtn.style.opacity = isAtEnd ? '0.3' : '1';
      nextBtn.style.pointerEvents = isAtEnd ? 'none' : 'auto';
    };

    track.addEventListener('scroll', updateNavState);
    updateNavState();
  })();
{% endjavascript %}

{% schema %}
{
  "name": "Curated collection carousel",
  "settings": [
    {
      "type": "header",
      "content": "Content"
    },
    {
      "type": "text",
      "id": "title_prefix",
      "label": "Title prefix",
      "default": "More from",
      "info": "Appears before the collection name (e.g. 'More from Indoor Lighting')"
    },
    {
      "type": "range",
      "id": "products_limit",
      "label": "Max products to show",
      "min": 4,
      "max": 16,
      "step": 1,
      "default": 10
    },
    {
      "type": "checkbox",
      "id": "show_view_all",
      "label": "Show 'View all' link",
      "default": true
    },
    {
      "type": "text",
      "id": "view_all_text",
      "label": "View all text",
      "default": "View All"
    },
    {
      "type": "header",
      "content": "Section style"
    },
    {
      "type": "color",
      "id": "section_bg",
      "label": "Background color",
      "default": "#ffffff"
    },
    {
      "type": "range",
      "id": "padding_top",
      "label": "Padding top",
      "min": 0,
      "max": 100,
      "step": 4,
      "default": 48,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "label": "Padding bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "default": 48,
      "unit": "px"
    },
    {
      "type": "header",
      "content": "Title"
    },
    {
      "type": "color",
      "id": "title_color",
      "label": "Color",
      "default": "#1C1917"
    },
    {
      "type": "range",
      "id": "title_size",
      "label": "Size (desktop)",
      "min": 18,
      "max": 40,
      "step": 1,
      "default": 24,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "title_size_mobile",
      "label": "Size (mobile)",
      "min": 16,
      "max": 28,
      "step": 1,
      "default": 18,
      "unit": "px"
    },
    {
      "type": "select",
      "id": "title_weight",
      "label": "Weight",
      "options": [
        { "value": "400", "label": "Regular" },
        { "value": "500", "label": "Medium" },
        { "value": "600", "label": "Semibold" },
        { "value": "700", "label": "Bold" }
      ],
      "default": "600"
    },
    {
      "type": "header",
      "content": "Product cards"
    },
    {
      "type": "color",
      "id": "card_bg",
      "label": "Card background",
      "default": "#ffffff"
    },
    {
      "type": "range",
      "id": "card_radius",
      "label": "Card border radius",
      "min": 0,
      "max": 20,
      "step": 2,
      "default": 8,
      "unit": "px"
    },
    {
      "type": "color",
      "id": "product_name_color",
      "label": "Product name color",
      "default": "#1C1917"
    },
    {
      "type": "range",
      "id": "product_name_size",
      "label": "Product name size (desktop)",
      "min": 13,
      "max": 20,
      "step": 1,
      "default": 15,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "product_name_size_mobile",
      "label": "Product name size (mobile)",
      "min": 12,
      "max": 18,
      "step": 1,
      "default": 14,
      "unit": "px"
    },
    {
      "type": "color",
      "id": "price_color",
      "label": "Price color",
      "default": "#57534E"
    },
    {
      "type": "range",
      "id": "price_size",
      "label": "Price size",
      "min": 12,
      "max": 18,
      "step": 1,
      "default": 14,
      "unit": "px"
    },
    {
      "type": "header",
      "content": "Navigation arrows"
    },
    {
      "type": "color",
      "id": "nav_bg",
      "label": "Arrow background",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "nav_color",
      "label": "Arrow color",
      "default": "#1C1917"
    }
  ],
  "blocks": [
    {
      "type": "collection",
      "name": "Collection",
      "settings": [
        {
          "type": "collection",
          "id": "collection",
          "label": "Collection"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Curated collection carousel",
      "blocks": [
        { "type": "collection" },
        { "type": "collection" },
        { "type": "collection" }
      ]
    }
  ]
}
{% endschema %}

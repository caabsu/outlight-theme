{% comment %}
  Collection page with hero image header and filter bar
{% endcomment %}

<div class="collection-page" data-collection-page>
  {%- comment -%} Hero Section {%- endcomment -%}
  <div class="collection-hero full-width" style="
    --hero-height-mobile: {{ section.settings.hero_height_mobile }}px;
    --hero-height-desktop: {{ section.settings.hero_height_desktop }}px;
    --hero-overlay-opacity: {{ section.settings.overlay_opacity | divided_by: 100.0 }};
    --content-padding-x-mobile: {{ section.settings.content_padding_x_mobile }}px;
    --content-padding-x-desktop: {{ section.settings.content_padding_x_desktop }}px;
    --content-padding-bottom-mobile: {{ section.settings.content_padding_bottom_mobile }}px;
    --content-padding-bottom-desktop: {{ section.settings.content_padding_bottom_desktop }}px;
    --title-size-mobile: {{ section.settings.title_size_mobile }}px;
    --title-size-desktop: {{ section.settings.title_size_desktop }}px;
    --title-color: {{ section.settings.title_color }};
    --title-weight: {{ section.settings.title_weight }};
    --subtitle-size-mobile: {{ section.settings.subtitle_size_mobile }}px;
    --subtitle-size-desktop: {{ section.settings.subtitle_size_desktop }}px;
    --subtitle-color: {{ section.settings.subtitle_color }};
    --subtitle-weight: {{ section.settings.subtitle_weight }};
  ">
    <div class="collection-hero__image-wrapper">
      {%- if section.settings.hero_image != blank -%}
        {{ section.settings.hero_image | image_url: width: 1920 | image_tag: class: 'collection-hero__image', loading: 'eager' }}
      {%- elsif collection.image -%}
        {{ collection.image | image_url: width: 1920 | image_tag: class: 'collection-hero__image', loading: 'eager' }}
      {%- else -%}
        <div class="collection-hero__placeholder"></div>
      {%- endif -%}
      <div class="collection-hero__overlay"></div>
    </div>

    <div class="collection-hero__content">
      <h1 class="collection-hero__title">{{ section.settings.custom_title | default: collection.title }}</h1>
      {%- if section.settings.subtitle != blank -%}
        <p class="collection-hero__subtitle">{{ section.settings.subtitle }}</p>
      {%- endif -%}
    </div>
  </div>

  {%- comment -%} Filter Bar {%- endcomment -%}
  {% if section.settings.show_filter_bar %}
    <div class="collection-filter-bar" data-filter-bar style="
      --filter-bar-bg: {{ section.settings.filter_bar_bg }};
      --filter-bar-radius: {{ section.settings.filter_bar_radius }}px;
      --filter-bar-text-size: {{ section.settings.filter_bar_text_size }}px;
      --filter-bar-text-color: {{ section.settings.filter_bar_text_color }};
      --filter-bar-text-weight: {{ section.settings.filter_bar_text_weight }};
      --filter-bar-icon-size: {{ section.settings.filter_bar_icon_size }}px;
      --filter-bar-divider-color: {{ section.settings.filter_bar_divider_color }};
    ">
      {%- comment -%} Default buttons state {%- endcomment -%}
      <div class="collection-filter-bar__inner" data-filter-bar-buttons>
        <button type="button" class="collection-filter-bar__btn" data-filter-toggle>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <line x1="4" y1="6" x2="20" y2="6"></line>
            <line x1="4" y1="12" x2="20" y2="12"></line>
            <line x1="4" y1="18" x2="20" y2="18"></line>
            <circle cx="8" cy="6" r="2" fill="currentColor"></circle>
            <circle cx="16" cy="12" r="2" fill="currentColor"></circle>
            <circle cx="10" cy="18" r="2" fill="currentColor"></circle>
          </svg>
          <span>{{ section.settings.filter_text | default: 'FILTER' }}</span>
        </button>
        <span class="collection-filter-bar__divider"></span>
        <button type="button" class="collection-filter-bar__btn" data-sort-toggle>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <line x1="4" y1="6" x2="14" y2="6"></line>
            <line x1="4" y1="12" x2="11" y2="12"></line>
            <line x1="4" y1="18" x2="8" y2="18"></line>
            <polyline points="15 15 18 18 21 15"></polyline>
            <line x1="18" y1="6" x2="18" y2="18"></line>
          </svg>
          <span>{{ section.settings.sort_text | default: 'SORT' }}</span>
        </button>
        <span class="collection-filter-bar__divider"></span>
        <button type="button" class="collection-filter-bar__btn" data-search-toggle>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <circle cx="11" cy="11" r="7"></circle>
            <line x1="16" y1="16" x2="21" y2="21"></line>
          </svg>
          <span>{{ section.settings.search_text | default: 'SEARCH' }}</span>
        </button>
      </div>

      {%- comment -%} Search input state {%- endcomment -%}
      <div class="collection-filter-bar__search" data-filter-bar-search hidden>
        <svg class="collection-filter-bar__search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <circle cx="11" cy="11" r="7"></circle>
          <line x1="16" y1="16" x2="21" y2="21"></line>
        </svg>
        <input
          type="text"
          class="collection-filter-bar__search-input"
          data-search-input
          placeholder="Search products..."
          autocomplete="off"
        >
        <button type="button" class="collection-filter-bar__search-clear" data-search-clear>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
    </div>

    {%- comment -%} Sort Dropdown {%- endcomment -%}
    <div class="collection-sort-dropdown" data-sort-dropdown hidden>
      <div class="collection-sort-dropdown__inner">
        <button type="button" class="collection-sort-dropdown__close" data-sort-close>
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
        <h3 class="collection-sort-dropdown__title">Sort By</h3>
        <div class="collection-sort-dropdown__options">
          {% assign sort_options = 'manual,best-selling,title-ascending,title-descending,price-ascending,price-descending,created-ascending,created-descending' | split: ',' %}
          {% assign sort_labels = 'Featured,Best Selling,A-Z,Z-A,Price: Low to High,Price: High to Low,Oldest,Newest' | split: ',' %}
          {% for option in sort_options %}
            <button type="button" class="collection-sort-dropdown__option{% if collection.sort_by == option or option == 'manual' and collection.sort_by == blank %} is-active{% endif %}" data-sort-option="{{ option }}">
              {{ sort_labels[forloop.index0] }}
            </button>
          {% endfor %}
        </div>
      </div>
    </div>

    {%- comment -%} Filter Modal {%- endcomment -%}
    <div class="collection-filter-modal" data-filter-modal hidden>
      <div class="collection-filter-modal__backdrop" data-filter-close></div>
      <div class="collection-filter-modal__content">
        <div class="collection-filter-modal__header">
          <h3 class="collection-filter-modal__title">Filters</h3>
          <button type="button" class="collection-filter-modal__close" data-filter-close>
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        </div>
        <div class="collection-filter-modal__body">
          {%- comment -%} Price Filter {%- endcomment -%}
          <div class="collection-filter-group">
            <h4 class="collection-filter-group__title">Price Range</h4>
            <div class="collection-filter-price">
              <div class="collection-filter-price__input">
                <label>Min</label>
                <input type="number" data-price-min placeholder="0" min="0">
              </div>
              <span class="collection-filter-price__separator">â€”</span>
              <div class="collection-filter-price__input">
                <label>Max</label>
                <input type="number" data-price-max placeholder="Any" min="0">
              </div>
            </div>
          </div>

          {%- comment -%} Collection Filter {%- endcomment -%}
          {% if section.settings.filter_collection_1 != blank or section.settings.filter_collection_2 != blank %}
            <div class="collection-filter-group">
              <h4 class="collection-filter-group__title">Category</h4>
              <div class="collection-filter-collections">
                {% if section.settings.filter_collection_1 != blank %}
                  <button type="button" class="collection-filter-collection" data-filter-cat="{{ section.settings.filter_collection_1.handle }}">
                    {{ section.settings.filter_collection_1_text | default: section.settings.filter_collection_1.title }}
                  </button>
                {% endif %}
                {% if section.settings.filter_collection_2 != blank %}
                  <button type="button" class="collection-filter-collection" data-filter-cat="{{ section.settings.filter_collection_2.handle }}">
                    {{ section.settings.filter_collection_2_text | default: section.settings.filter_collection_2.title }}
                  </button>
                {% endif %}
                {% if section.settings.filter_collection_3 != blank %}
                  <button type="button" class="collection-filter-collection" data-filter-cat="{{ section.settings.filter_collection_3.handle }}">
                    {{ section.settings.filter_collection_3_text | default: section.settings.filter_collection_3.title }}
                  </button>
                {% endif %}
                {% if section.settings.filter_collection_4 != blank %}
                  <button type="button" class="collection-filter-collection" data-filter-cat="{{ section.settings.filter_collection_4.handle }}">
                    {{ section.settings.filter_collection_4_text | default: section.settings.filter_collection_4.title }}
                  </button>
                {% endif %}
                {% if section.settings.filter_collection_5 != blank %}
                  <button type="button" class="collection-filter-collection" data-filter-cat="{{ section.settings.filter_collection_5.handle }}">
                    {{ section.settings.filter_collection_5_text | default: section.settings.filter_collection_5.title }}
                  </button>
                {% endif %}
                {% if section.settings.filter_collection_6 != blank %}
                  <button type="button" class="collection-filter-collection" data-filter-cat="{{ section.settings.filter_collection_6.handle }}">
                    {{ section.settings.filter_collection_6_text | default: section.settings.filter_collection_6.title }}
                  </button>
                {% endif %}
              </div>
            </div>
          {% endif %}
        </div>
        <div class="collection-filter-modal__footer">
          <button type="button" class="collection-filter-modal__clear" data-filter-clear>Clear All</button>
          <button type="button" class="collection-filter-modal__apply" data-filter-apply>Apply Filters</button>
        </div>
      </div>
    </div>

  {% endif %}

  {%- comment -%} Products Grid {%- endcomment -%}
  <div class="collection-products" style="
    --products-gap: {{ section.settings.products_gap }}px;
    --products-padding-x-mobile: {{ section.settings.products_padding_x_mobile }}px;
    --products-padding-x-desktop: {{ section.settings.products_padding_x_desktop }}px;
    --products-padding-top: {{ section.settings.products_padding_top }}px;
    --products-padding-bottom: {{ section.settings.products_padding_bottom }}px;
    --product-title-size: {{ section.settings.product_title_size }}px;
    --product-title-color: {{ section.settings.product_title_color }};
    --product-title-weight: {{ section.settings.product_title_weight }};
    --product-price-size: {{ section.settings.product_price_size }}px;
    --product-price-color: {{ section.settings.product_price_color }};
    --product-price-weight: {{ section.settings.product_price_weight }};
  ">
    {% paginate collection.products by section.settings.products_per_page %}
      <div class="collection-products__grid" data-products-grid>
        {% for product in collection.products %}
          {%- capture product_collections -%}
            {%- for col in product.collections -%}{{ col.handle }}{% unless forloop.last %},{% endunless %}{%- endfor -%}
          {%- endcapture -%}
          <a href="{{ product.url }}" class="collection-product" data-product data-collections="{{ product_collections }}" data-title="{{ product.title | downcase }}">
            <div class="collection-product__image-wrapper">
              {% if product.featured_image %}
                {{ product.featured_image | image_url: width: 600, height: 600, crop: 'center' | image_tag: class: 'collection-product__image', loading: 'lazy' }}
              {% else %}
                <div class="collection-product__placeholder"></div>
              {% endif %}
            </div>
            <div class="collection-product__content">
              <h3 class="collection-product__title">{{ product.title }}</h3>
              <p class="collection-product__price">{{ product.price | money }}</p>
            </div>
          </a>
        {% endfor %}
      </div>

      {%- if paginate.pages > 1 -%}
        <div class="collection-pagination">
          {{ paginate | default_pagination }}
        </div>
      {%- endif -%}
    {% endpaginate %}
  </div>
</div>

{% stylesheet %}
  .collection-page {
    width: 100%;
  }

  /* Hero Section - Full Width */
  .collection-hero {
    position: relative;
    width: 100vw;
    margin-left: calc(-50vw + 50%);
    height: var(--hero-height-mobile, 300px);
    overflow: hidden;
  }

  .collection-hero__image-wrapper {
    position: absolute;
    inset: 0;
  }

  .collection-hero__image {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .collection-hero__placeholder {
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, #E7E5E4 0%, #D6D3D1 100%);
  }

  .collection-hero__overlay {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, var(--hero-overlay-opacity, 0.3));
  }

  .collection-hero__content {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    justify-content: flex-end;
    align-items: flex-start;
    padding-left: var(--content-padding-x-mobile, 24px);
    padding-right: var(--content-padding-x-mobile, 24px);
    padding-bottom: var(--content-padding-bottom-mobile, 24px);
    z-index: 1;
  }

  .collection-hero__title {
    font-family: var(--font-heading-family), serif;
    font-size: var(--title-size-mobile, 36px);
    font-weight: var(--title-weight, 400);
    color: var(--title-color, #ffffff);
    margin: 0;
    line-height: 1.1;
  }

  .collection-hero__subtitle {
    font-family: var(--font-body-family), sans-serif;
    font-size: var(--subtitle-size-mobile, 14px);
    font-weight: var(--subtitle-weight, 400);
    color: var(--subtitle-color, rgba(255, 255, 255, 0.8));
    margin: 8px 0 0;
    line-height: 1.4;
  }

  /* Products Grid */
  .collection-products {
    padding-top: var(--products-padding-top, 24px);
    padding-bottom: var(--products-padding-bottom, 48px);
    padding-left: var(--products-padding-x-mobile, 12px);
    padding-right: var(--products-padding-x-mobile, 12px);
  }

  .collection-products__grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--products-gap, 16px);
  }

  .collection-product {
    text-decoration: none;
    color: inherit;
    display: block;
  }

  .collection-product__image-wrapper {
    aspect-ratio: 1 / 1;
    overflow: hidden;
    background-color: #f5f5f5;
    margin-bottom: 12px;
  }

  .collection-product__image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s ease;
  }

  .collection-product:hover .collection-product__image {
    transform: scale(1.03);
  }

  .collection-product__placeholder {
    width: 100%;
    height: 100%;
    background-color: #e5e5e5;
  }

  .collection-product__content {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    gap: 8px;
    padding: 0 4px;
  }

  .collection-product__title {
    font-family: var(--font-heading-family), serif;
    font-size: var(--product-title-size, 16px);
    font-weight: var(--product-title-weight, 400);
    color: var(--product-title-color, #1C1917);
    margin: 0;
    line-height: 1.3;
    flex: 1;
  }

  .collection-product__price {
    font-family: var(--font-body-family), sans-serif;
    font-size: var(--product-price-size, 14px);
    font-weight: var(--product-price-weight, 400);
    color: var(--product-price-color, #78716C);
    margin: 0;
    flex-shrink: 0;
    text-align: right;
  }

  .collection-no-results {
    grid-column: 1 / -1;
    text-align: center;
    padding: 60px 20px;
    color: #78716C;
    font-family: var(--font-body-family), sans-serif;
    font-size: 16px;
  }

  .collection-pagination {
    margin-top: 48px;
    margin-bottom: 16px;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 4px;
    flex-wrap: wrap;
  }

  .collection-pagination a,
  .collection-pagination span {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 40px;
    height: 40px;
    padding: 0 12px;
    font-family: var(--font-body-family), sans-serif;
    font-size: 14px;
    font-weight: 500;
    color: #57534E;
    text-decoration: none;
    border-radius: 8px;
    transition: all 0.2s ease;
  }

  .collection-pagination a:hover {
    background: #F5F5F4;
    color: #1C1917;
  }

  .collection-pagination span.current {
    background: #1C1917;
    color: #ffffff;
    font-weight: 600;
  }

  .collection-pagination span.deco {
    min-width: auto;
    padding: 0 4px;
    color: #A8A29E;
  }

  /* Previous/Next text styling */
  .collection-pagination a[href*="page"]:first-child,
  .collection-pagination a[href*="page"]:last-child {
    font-weight: 500;
    letter-spacing: 0.02em;
  }

  @media (max-width: 767px) {
    .collection-pagination {
      gap: 2px;
    }

    .collection-pagination a,
    .collection-pagination span {
      min-width: 36px;
      height: 36px;
      padding: 0 8px;
      font-size: 13px;
      border-radius: 6px;
    }
  }

  /* Desktop */
  @media (min-width: 768px) {
    .collection-hero {
      height: var(--hero-height-desktop, 450px);
    }

    .collection-hero__content {
      padding-left: var(--content-padding-x-desktop, 60px);
      padding-right: var(--content-padding-x-desktop, 60px);
      padding-bottom: var(--content-padding-bottom-desktop, 60px);
    }

    .collection-hero__title {
      font-size: var(--title-size-desktop, 56px);
    }

    .collection-hero__subtitle {
      font-size: var(--subtitle-size-desktop, 16px);
      margin-top: 12px;
    }

    .collection-products {
      padding-left: var(--products-padding-x-desktop, 24px);
      padding-right: var(--products-padding-x-desktop, 24px);
    }

    .collection-products__grid {
      grid-template-columns: repeat(3, 1fr);
      gap: var(--products-gap, 24px);
    }

    .collection-product__image-wrapper {
      margin-bottom: 16px;
    }

    .collection-product__title {
      font-size: calc(var(--product-title-size, 16px) + 2px);
    }
  }

  @media (min-width: 1024px) {
    .collection-products__grid {
      grid-template-columns: repeat(4, 1fr);
    }
  }

  /* Filter Bar */
  .collection-filter-bar {
    display: flex;
    justify-content: center;
    padding: 16px 20px;
  }

  .collection-filter-bar__inner {
    display: inline-flex;
    align-items: center;
    background: var(--filter-bar-bg, #ffffff);
    border-radius: var(--filter-bar-radius, 50px);
    padding: 10px 8px;
  }

  .collection-filter-bar__inner[hidden] {
    display: none;
  }

  .collection-filter-bar__btn {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 16px;
    background: none;
    border: none;
    cursor: pointer;
    font-family: var(--font-body-family), sans-serif;
    font-size: var(--filter-bar-text-size, 12px);
    font-weight: var(--filter-bar-text-weight, 500);
    color: var(--filter-bar-text-color, #1C1917);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    transition: opacity 0.2s ease;
  }

  .collection-filter-bar__btn:hover {
    opacity: 0.7;
  }

  .collection-filter-bar__btn svg {
    width: var(--filter-bar-icon-size, 16px);
    height: var(--filter-bar-icon-size, 16px);
    flex-shrink: 0;
  }

  .collection-filter-bar__divider {
    width: 1px;
    height: 20px;
    background: var(--filter-bar-divider-color, #E5E5E5);
  }

  /* Inline Search */
  .collection-filter-bar__search {
    display: flex;
    align-items: center;
    gap: 12px;
    background: var(--filter-bar-bg, #ffffff);
    border-radius: var(--filter-bar-radius, 50px);
    padding: 8px 16px;
    min-width: 280px;
  }

  .collection-filter-bar__search[hidden] {
    display: none;
  }

  .collection-filter-bar__search-icon {
    width: var(--filter-bar-icon-size, 16px);
    height: var(--filter-bar-icon-size, 16px);
    color: var(--filter-bar-text-color, #1C1917);
    flex-shrink: 0;
    opacity: 0.6;
  }

  .collection-filter-bar__search-input {
    flex: 1;
    border: none;
    outline: none;
    background: transparent;
    font-family: var(--font-body-family), sans-serif;
    font-size: 14px;
    color: var(--filter-bar-text-color, #1C1917);
    min-width: 0;
  }

  .collection-filter-bar__search-input::placeholder {
    color: #A8A29E;
  }

  .collection-filter-bar__search-clear {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 28px;
    height: 28px;
    padding: 0;
    background: #F5F5F4;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    color: #57534E;
    flex-shrink: 0;
    transition: all 0.2s ease;
  }

  .collection-filter-bar__search-clear:hover {
    background: #E7E5E4;
    color: #1C1917;
  }

  .collection-filter-bar__search-clear svg {
    width: 14px;
    height: 14px;
  }

  @media (min-width: 768px) {
    .collection-filter-bar__search {
      min-width: 360px;
    }
  }

  /* Sort Dropdown */
  .collection-sort-dropdown {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.4);
    z-index: 1000;
    display: flex;
    align-items: flex-end;
    justify-content: center;
  }

  .collection-sort-dropdown[hidden] {
    display: none;
  }

  .collection-sort-dropdown__inner {
    position: relative;
    background: #ffffff;
    width: 100%;
    max-width: 500px;
    border-radius: 16px 16px 0 0;
    padding: 24px;
    max-height: 80vh;
    overflow-y: auto;
  }

  .collection-sort-dropdown__close {
    position: absolute;
    top: 16px;
    right: 16px;
    background: none;
    border: none;
    cursor: pointer;
    padding: 8px;
    color: #78716C;
  }

  .collection-sort-dropdown__title {
    font-family: var(--font-heading-family), serif;
    font-size: 20px;
    font-weight: 400;
    margin: 0 0 20px;
    color: #1C1917;
  }

  .collection-sort-dropdown__options {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .collection-sort-dropdown__option {
    display: block;
    width: 100%;
    text-align: left;
    padding: 14px 16px;
    background: none;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-family: var(--font-body-family), sans-serif;
    font-size: 16px;
    color: #1C1917;
    transition: background-color 0.2s ease;
  }

  .collection-sort-dropdown__option:hover {
    background-color: #F5F5F4;
  }

  .collection-sort-dropdown__option.is-active {
    background-color: #1C1917;
    color: #ffffff;
  }

  /* Filter Modal */
  .collection-filter-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 1000;
    display: flex;
    align-items: flex-end;
    justify-content: center;
  }

  .collection-filter-modal[hidden] {
    display: none;
  }

  .collection-filter-modal__backdrop {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.4);
  }

  .collection-filter-modal__content {
    position: relative;
    background: #ffffff;
    width: 100%;
    max-width: 500px;
    border-radius: 16px 16px 0 0;
    max-height: 85vh;
    display: flex;
    flex-direction: column;
  }

  .collection-filter-modal__header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 20px 24px;
    border-bottom: 1px solid #E5E5E5;
  }

  .collection-filter-modal__title {
    font-family: var(--font-heading-family), serif;
    font-size: 20px;
    font-weight: 400;
    margin: 0;
    color: #1C1917;
  }

  .collection-filter-modal__close {
    background: none;
    border: none;
    cursor: pointer;
    padding: 8px;
    color: #78716C;
  }

  .collection-filter-modal__body {
    flex: 1;
    overflow-y: auto;
    padding: 24px;
  }

  .collection-filter-group {
    margin-bottom: 32px;
  }

  .collection-filter-group:last-child {
    margin-bottom: 0;
  }

  .collection-filter-group__title {
    font-family: var(--font-body-family), sans-serif;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: #78716C;
    margin: 0 0 16px;
  }

  .collection-filter-price {
    display: flex;
    align-items: center;
    gap: 16px;
  }

  .collection-filter-price__input {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .collection-filter-price__input label {
    font-size: 12px;
    color: #78716C;
  }

  .collection-filter-price__input input {
    padding: 12px;
    border: 1px solid #E5E5E5;
    border-radius: 8px;
    font-size: 16px;
    width: 100%;
  }

  .collection-filter-price__separator {
    color: #A8A29E;
    padding-top: 20px;
  }

  .collection-filter-collections {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }

  .collection-filter-collection {
    padding: 10px 16px;
    background: #F5F5F4;
    border-radius: 50px;
    font-family: var(--font-body-family), sans-serif;
    font-size: 14px;
    color: #1C1917;
    text-decoration: none;
    transition: all 0.2s ease;
  }

  .collection-filter-collection:hover {
    background: #E7E5E4;
  }

  .collection-filter-collection.is-active {
    background: #1C1917;
    color: #ffffff;
  }

  .collection-filter-modal__footer {
    display: flex;
    gap: 12px;
    padding: 20px 24px;
    border-top: 1px solid #E5E5E5;
  }

  .collection-filter-modal__clear {
    flex: 1;
    padding: 14px 24px;
    background: none;
    border: 1px solid #E5E5E5;
    border-radius: 8px;
    cursor: pointer;
    font-family: var(--font-body-family), sans-serif;
    font-size: 14px;
    font-weight: 500;
    color: #78716C;
    transition: all 0.2s ease;
  }

  .collection-filter-modal__clear:hover {
    background: #F5F5F4;
  }

  .collection-filter-modal__apply {
    flex: 1;
    padding: 14px 24px;
    background: #1C1917;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-family: var(--font-body-family), sans-serif;
    font-size: 14px;
    font-weight: 500;
    color: #ffffff;
    transition: opacity 0.2s ease;
  }

  .collection-filter-modal__apply:hover {
    opacity: 0.9;
  }

  @media (min-width: 768px) {
    .collection-sort-dropdown__inner,
    .collection-filter-modal__content {
      border-radius: 16px;
      margin-bottom: 40px;
    }

    .collection-sort-dropdown {
      align-items: center;
    }

    .collection-filter-modal {
      align-items: center;
    }
  }

{% endstylesheet %}

{% javascript %}
  (function() {
    const container = document.querySelector('[data-collection-page]');
    if (!container) return;

    // Shared elements
    const products = container.querySelectorAll('[data-product]');
    const productsGrid = container.querySelector('[data-products-grid]');
    const pagination = container.querySelector('.collection-pagination');
    const filterCats = container.querySelectorAll('[data-filter-cat]');
    let selectedCategories = new Set();
    let currentSearchTerm = '';
    let allCollectionProducts = null;
    let isSearching = false;
    let originalProductsHTML = productsGrid ? productsGrid.innerHTML : '';

    // Get collection handle from URL
    const getCollectionHandle = () => {
      const path = window.location.pathname;
      const match = path.match(/\/collections\/([^\/\?]+)/);
      return match ? match[1] : null;
    };

    // Fetch all products from collection
    const fetchAllProducts = async () => {
      if (allCollectionProducts !== null) return allCollectionProducts;

      const handle = getCollectionHandle();
      if (!handle) return [];

      let products = [];
      let page = 1;
      let hasMore = true;

      while (hasMore) {
        try {
          const response = await fetch(`/collections/${handle}/products.json?limit=250&page=${page}`);
          const data = await response.json();

          if (data.products && data.products.length > 0) {
            products = products.concat(data.products);
            page++;
            if (data.products.length < 250) hasMore = false;
          } else {
            hasMore = false;
          }
        } catch (e) {
          console.error('Error fetching products:', e);
          hasMore = false;
        }
      }

      allCollectionProducts = products;
      return products;
    };

    // Render search results
    const renderSearchResults = (products) => {
      if (!productsGrid) return;

      if (products.length === 0) {
        productsGrid.innerHTML = '<div class="collection-no-results">No products found</div>';
        return;
      }

      const html = products.map(product => {
        const imageUrl = product.images && product.images[0]
          ? product.images[0].src.replace(/\.([^\.]+)$/, '_600x600_crop_center.$1')
          : '';
        const price = product.variants && product.variants[0]
          ? (product.variants[0].price / 100).toLocaleString('en-US', { style: 'currency', currency: 'USD' })
          : '';

        return `
          <a href="/products/${product.handle}" class="collection-product" data-product>
            <div class="collection-product__image-wrapper">
              ${imageUrl ? `<img src="${imageUrl}" alt="${product.title}" class="collection-product__image" loading="lazy">` : '<div class="collection-product__placeholder"></div>'}
            </div>
            <div class="collection-product__content">
              <h3 class="collection-product__title">${product.title}</h3>
              <p class="collection-product__price">${price}</p>
            </div>
          </a>
        `;
      }).join('');

      productsGrid.innerHTML = html;
    };

    // Search products
    const searchProducts = async (term) => {
      if (!term) {
        // Restore original products
        if (productsGrid) productsGrid.innerHTML = originalProductsHTML;
        if (pagination) pagination.style.display = '';
        isSearching = false;
        return;
      }

      isSearching = true;
      if (pagination) pagination.style.display = 'none';

      const allProducts = await fetchAllProducts();
      const searchLower = term.toLowerCase();

      const filtered = allProducts.filter(product => {
        return product.title.toLowerCase().includes(searchLower) ||
               (product.product_type && product.product_type.toLowerCase().includes(searchLower)) ||
               (product.vendor && product.vendor.toLowerCase().includes(searchLower)) ||
               (product.tags && product.tags.some(tag => tag.toLowerCase().includes(searchLower)));
      });

      renderSearchResults(filtered);
    };

    // Combined filter function (for non-search filtering on current page)
    const applyAllFilters = () => {
      if (isSearching) return; // Don't apply page filters during search

      products.forEach(product => {
        const productCollections = (product.dataset.collections || '').split(',').map(c => c.trim());

        // Apply category filter only
        let matchesCategory = true;
        if (selectedCategories.size > 0) {
          matchesCategory = [...selectedCategories].some(cat => productCollections.includes(cat));
        }

        product.style.display = matchesCategory ? '' : 'none';
      });
    };

    // Sort functionality
    const sortToggle = container.querySelector('[data-sort-toggle]');
    const sortDropdown = container.querySelector('[data-sort-dropdown]');
    const sortClose = container.querySelector('[data-sort-close]');
    const sortOptions = container.querySelectorAll('[data-sort-option]');

    if (sortToggle && sortDropdown) {
      sortToggle.addEventListener('click', () => {
        sortDropdown.hidden = false;
        document.body.style.overflow = 'hidden';
      });

      const closeSort = () => {
        sortDropdown.hidden = true;
        document.body.style.overflow = '';
      };

      if (sortClose) sortClose.addEventListener('click', closeSort);
      sortDropdown.addEventListener('click', (e) => {
        if (e.target === sortDropdown) closeSort();
      });

      sortOptions.forEach(option => {
        option.addEventListener('click', () => {
          const sortBy = option.dataset.sortOption;
          const url = new URL(window.location.href);
          url.searchParams.set('sort_by', sortBy);
          window.location.href = url.toString();
        });
      });
    }

    // Filter functionality
    const filterToggle = container.querySelector('[data-filter-toggle]');
    const filterModal = container.querySelector('[data-filter-modal]');
    const filterCloses = container.querySelectorAll('[data-filter-close]');
    const filterClear = container.querySelector('[data-filter-clear]');
    const filterApply = container.querySelector('[data-filter-apply]');
    const priceMin = container.querySelector('[data-price-min]');
    const priceMax = container.querySelector('[data-price-max]');

    if (filterToggle && filterModal) {
      filterToggle.addEventListener('click', () => {
        filterModal.hidden = false;
        document.body.style.overflow = 'hidden';
      });

      const closeFilter = () => {
        filterModal.hidden = true;
        document.body.style.overflow = '';
      };

      filterCloses.forEach(btn => btn.addEventListener('click', closeFilter));

      // Category filter toggle
      filterCats.forEach(btn => {
        btn.addEventListener('click', () => {
          const cat = btn.dataset.filterCat;
          if (selectedCategories.has(cat)) {
            selectedCategories.delete(cat);
            btn.classList.remove('is-active');
          } else {
            selectedCategories.add(cat);
            btn.classList.add('is-active');
          }
        });
      });

      if (filterClear) {
        filterClear.addEventListener('click', () => {
          if (priceMin) priceMin.value = '';
          if (priceMax) priceMax.value = '';
          selectedCategories.clear();
          filterCats.forEach(btn => btn.classList.remove('is-active'));
          applyAllFilters();
        });
      }

      if (filterApply) {
        filterApply.addEventListener('click', () => {
          applyAllFilters();
          closeFilter();
        });
      }
    }

    // Inline Search functionality
    const searchToggle = container.querySelector('[data-search-toggle]');
    const searchInput = container.querySelector('[data-search-input]');
    const searchClear = container.querySelector('[data-search-clear]');
    const filterBarButtons = container.querySelector('[data-filter-bar-buttons]');
    const filterBarSearch = container.querySelector('[data-filter-bar-search]');

    const showSearchBar = () => {
      if (filterBarButtons) filterBarButtons.hidden = true;
      if (filterBarSearch) {
        filterBarSearch.hidden = false;
        if (searchInput) {
          searchInput.focus();
        }
      }
    };

    const hideSearchBar = () => {
      if (filterBarSearch) filterBarSearch.hidden = true;
      if (filterBarButtons) filterBarButtons.hidden = false;
      if (searchInput) {
        searchInput.value = '';
        currentSearchTerm = '';
        searchProducts(''); // Restore original products
      }
    };

    if (searchToggle) {
      searchToggle.addEventListener('click', showSearchBar);
    }

    if (searchClear) {
      searchClear.addEventListener('click', hideSearchBar);
    }

    // Dynamic search as user types - debounced for performance
    let searchTimeout = null;
    if (searchInput) {
      searchInput.addEventListener('input', (e) => {
        currentSearchTerm = e.target.value.toLowerCase().trim();

        // Debounce search requests
        if (searchTimeout) clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
          searchProducts(currentSearchTerm);
        }, 300);
      });

      // ESC key in search input closes search
      searchInput.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          hideSearchBar();
        }
      });
    }

    // ESC key closes all modals
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        if (sortDropdown && !sortDropdown.hidden) {
          sortDropdown.hidden = true;
          document.body.style.overflow = '';
        }
        if (filterModal && !filterModal.hidden) {
          filterModal.hidden = true;
          document.body.style.overflow = '';
        }
      }
    });
  })();
{% endjavascript %}

{% schema %}
{
  "name": "Collection Page",
  "settings": [
    {
      "type": "header",
      "content": "Hero Image"
    },
    {
      "type": "image_picker",
      "id": "hero_image",
      "label": "Custom hero image",
      "info": "Uses collection image by default. Set this to override."
    },
    {
      "type": "range",
      "id": "hero_height_mobile",
      "label": "Hero height (mobile)",
      "min": 200,
      "max": 500,
      "step": 25,
      "unit": "px",
      "default": 300
    },
    {
      "type": "range",
      "id": "hero_height_desktop",
      "label": "Hero height (desktop)",
      "min": 300,
      "max": 700,
      "step": 25,
      "unit": "px",
      "default": 450
    },
    {
      "type": "range",
      "id": "overlay_opacity",
      "label": "Overlay opacity",
      "min": 0,
      "max": 80,
      "step": 5,
      "unit": "%",
      "default": 30
    },
    {
      "type": "header",
      "content": "Filter Bar"
    },
    {
      "type": "checkbox",
      "id": "show_filter_bar",
      "label": "Show filter bar",
      "default": true
    },
    {
      "type": "color",
      "id": "filter_bar_bg",
      "label": "Background color",
      "default": "#ffffff"
    },
    {
      "type": "range",
      "id": "filter_bar_radius",
      "label": "Border radius",
      "min": 0,
      "max": 50,
      "step": 2,
      "unit": "px",
      "default": 50
    },
    {
      "type": "range",
      "id": "filter_bar_text_size",
      "label": "Text size",
      "min": 10,
      "max": 16,
      "step": 1,
      "unit": "px",
      "default": 12
    },
    {
      "type": "color",
      "id": "filter_bar_text_color",
      "label": "Text color",
      "default": "#1C1917"
    },
    {
      "type": "select",
      "id": "filter_bar_text_weight",
      "label": "Text weight",
      "options": [
        { "value": "400", "label": "Regular" },
        { "value": "500", "label": "Medium" },
        { "value": "600", "label": "Semibold" }
      ],
      "default": "500"
    },
    {
      "type": "range",
      "id": "filter_bar_icon_size",
      "label": "Icon size",
      "min": 12,
      "max": 20,
      "step": 1,
      "unit": "px",
      "default": 16
    },
    {
      "type": "color",
      "id": "filter_bar_divider_color",
      "label": "Divider color",
      "default": "#E5E5E5"
    },
    {
      "type": "text",
      "id": "filter_text",
      "label": "Filter button text",
      "default": "FILTER"
    },
    {
      "type": "text",
      "id": "sort_text",
      "label": "Sort button text",
      "default": "SORT"
    },
    {
      "type": "text",
      "id": "search_text",
      "label": "Search button text",
      "default": "SEARCH"
    },
    {
      "type": "header",
      "content": "Filter Collections"
    },
    {
      "type": "collection",
      "id": "filter_collection_1",
      "label": "Collection 1"
    },
    {
      "type": "text",
      "id": "filter_collection_1_text",
      "label": "Collection 1 label"
    },
    {
      "type": "collection",
      "id": "filter_collection_2",
      "label": "Collection 2"
    },
    {
      "type": "text",
      "id": "filter_collection_2_text",
      "label": "Collection 2 label"
    },
    {
      "type": "collection",
      "id": "filter_collection_3",
      "label": "Collection 3"
    },
    {
      "type": "text",
      "id": "filter_collection_3_text",
      "label": "Collection 3 label"
    },
    {
      "type": "collection",
      "id": "filter_collection_4",
      "label": "Collection 4"
    },
    {
      "type": "text",
      "id": "filter_collection_4_text",
      "label": "Collection 4 label"
    },
    {
      "type": "collection",
      "id": "filter_collection_5",
      "label": "Collection 5"
    },
    {
      "type": "text",
      "id": "filter_collection_5_text",
      "label": "Collection 5 label"
    },
    {
      "type": "collection",
      "id": "filter_collection_6",
      "label": "Collection 6"
    },
    {
      "type": "text",
      "id": "filter_collection_6_text",
      "label": "Collection 6 label"
    },
    {
      "type": "header",
      "content": "Content Position"
    },
    {
      "type": "range",
      "id": "content_padding_x_mobile",
      "label": "Horizontal padding (mobile)",
      "min": 16,
      "max": 80,
      "step": 4,
      "unit": "px",
      "default": 24
    },
    {
      "type": "range",
      "id": "content_padding_x_desktop",
      "label": "Horizontal padding (desktop)",
      "min": 20,
      "max": 160,
      "step": 10,
      "unit": "px",
      "default": 60
    },
    {
      "type": "range",
      "id": "content_padding_bottom_mobile",
      "label": "Bottom padding (mobile)",
      "min": 16,
      "max": 80,
      "step": 4,
      "unit": "px",
      "default": 24
    },
    {
      "type": "range",
      "id": "content_padding_bottom_desktop",
      "label": "Bottom padding (desktop)",
      "min": 20,
      "max": 120,
      "step": 10,
      "unit": "px",
      "default": 60
    },
    {
      "type": "header",
      "content": "Title"
    },
    {
      "type": "text",
      "id": "custom_title",
      "label": "Custom title",
      "info": "Leave blank to use collection title"
    },
    {
      "type": "range",
      "id": "title_size_mobile",
      "label": "Title size (mobile)",
      "min": 24,
      "max": 60,
      "step": 2,
      "unit": "px",
      "default": 36
    },
    {
      "type": "range",
      "id": "title_size_desktop",
      "label": "Title size (desktop)",
      "min": 32,
      "max": 80,
      "step": 2,
      "unit": "px",
      "default": 56
    },
    {
      "type": "color",
      "id": "title_color",
      "label": "Title color",
      "default": "#ffffff"
    },
    {
      "type": "select",
      "id": "title_weight",
      "label": "Title weight",
      "options": [
        { "value": "300", "label": "Light" },
        { "value": "400", "label": "Regular" },
        { "value": "500", "label": "Medium" },
        { "value": "600", "label": "Semibold" },
        { "value": "700", "label": "Bold" }
      ],
      "default": "400"
    },
    {
      "type": "header",
      "content": "Subtitle"
    },
    {
      "type": "text",
      "id": "subtitle",
      "label": "Subtitle"
    },
    {
      "type": "range",
      "id": "subtitle_size_mobile",
      "label": "Subtitle size (mobile)",
      "min": 12,
      "max": 24,
      "step": 1,
      "unit": "px",
      "default": 14
    },
    {
      "type": "range",
      "id": "subtitle_size_desktop",
      "label": "Subtitle size (desktop)",
      "min": 14,
      "max": 28,
      "step": 1,
      "unit": "px",
      "default": 16
    },
    {
      "type": "color",
      "id": "subtitle_color",
      "label": "Subtitle color",
      "default": "#ffffff"
    },
    {
      "type": "select",
      "id": "subtitle_weight",
      "label": "Subtitle weight",
      "options": [
        { "value": "300", "label": "Light" },
        { "value": "400", "label": "Regular" },
        { "value": "500", "label": "Medium" },
        { "value": "600", "label": "Semibold" },
        { "value": "700", "label": "Bold" }
      ],
      "default": "400"
    },
    {
      "type": "header",
      "content": "Products Grid"
    },
    {
      "type": "range",
      "id": "products_per_page",
      "label": "Products per page",
      "min": 8,
      "max": 48,
      "step": 4,
      "default": 20
    },
    {
      "type": "range",
      "id": "products_gap",
      "label": "Gap between products",
      "min": 4,
      "max": 40,
      "step": 2,
      "unit": "px",
      "default": 12
    },
    {
      "type": "range",
      "id": "products_padding_x_mobile",
      "label": "Side padding (mobile)",
      "min": 0,
      "max": 40,
      "step": 4,
      "unit": "px",
      "default": 8
    },
    {
      "type": "range",
      "id": "products_padding_x_desktop",
      "label": "Side padding (desktop)",
      "min": 0,
      "max": 80,
      "step": 4,
      "unit": "px",
      "default": 16
    },
    {
      "type": "range",
      "id": "products_padding_top",
      "label": "Top padding",
      "min": 0,
      "max": 80,
      "step": 4,
      "unit": "px",
      "default": 24
    },
    {
      "type": "range",
      "id": "products_padding_bottom",
      "label": "Bottom padding",
      "min": 0,
      "max": 120,
      "step": 4,
      "unit": "px",
      "default": 48
    },
    {
      "type": "header",
      "content": "Product Title"
    },
    {
      "type": "range",
      "id": "product_title_size",
      "label": "Product title size",
      "min": 12,
      "max": 24,
      "step": 1,
      "unit": "px",
      "default": 16
    },
    {
      "type": "color",
      "id": "product_title_color",
      "label": "Product title color",
      "default": "#1C1917"
    },
    {
      "type": "select",
      "id": "product_title_weight",
      "label": "Product title weight",
      "options": [
        { "value": "300", "label": "Light" },
        { "value": "400", "label": "Regular" },
        { "value": "500", "label": "Medium" },
        { "value": "600", "label": "Semibold" },
        { "value": "700", "label": "Bold" }
      ],
      "default": "400"
    },
    {
      "type": "header",
      "content": "Product Price"
    },
    {
      "type": "range",
      "id": "product_price_size",
      "label": "Product price size",
      "min": 12,
      "max": 20,
      "step": 1,
      "unit": "px",
      "default": 14
    },
    {
      "type": "color",
      "id": "product_price_color",
      "label": "Product price color",
      "default": "#78716C"
    },
    {
      "type": "select",
      "id": "product_price_weight",
      "label": "Product price weight",
      "options": [
        { "value": "300", "label": "Light" },
        { "value": "400", "label": "Regular" },
        { "value": "500", "label": "Medium" },
        { "value": "600", "label": "Semibold" },
        { "value": "700", "label": "Bold" }
      ],
      "default": "400"
    }
  ],
  "templates": ["collection"]
}
{% endschema %}
